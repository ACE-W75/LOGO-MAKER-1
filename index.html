<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Professional AI Logo Studio - Classic Edition">
    <title>NEXUS STUDIO | AI Logo Architect</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Kufi+Arabic:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* --- Color Palette: Midnight Luxury --- */
            --bg-main: #0a0a0f; /* Deepest background */
            --bg-secondary: #121218; /* Panels background */
            --bg-tertiary: #1a1a24; /* Inputs and cards */
            
            --accent-primary: #d4af37; /* Classic Gold */
            --accent-secondary: #3b82f6; /* Professional Blue */
            --accent-success: #10b981;
            --accent-danger: #ef4444;

            --text-primary: #ffffff;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;

            --border-light: rgba(255, 255, 255, 0.08);
            --border-hover: rgba(212, 175, 55, 0.5); /* Gold hover */

            /* --- Typography --- */
            --font-en: 'Inter', sans-serif;
            --font-ar: 'Noto Kufi Arabic', sans-serif;

            /* --- Effects --- */
            --shadow-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
            --glow-gold: 0 0 20px rgba(212, 175, 55, 0.2);
        }

        /* --- Base Reset & Typography --- */
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            scrollbar-width: thin;
            scrollbar-color: var(--bg-tertiary) var(--bg-main);
        }
        
        html, body {
            height: 100%;
            background-color: var(--bg-main);
            color: var(--text-primary);
            font-family: var(--font-ar);
            overflow: hidden;
        }

        /* --- scrollbar styling --- */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-main); }
        ::-webkit-scrollbar-thumb { background-color: var(--bg-tertiary); border-radius: 20px; }

        /* --- Utility Classes & Components --- */
        .panel-classic {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            transition: all 0.3s ease;
        }

        .input-classic {
            width: 100%;
            background-color: var(--bg-tertiary);
            border: 1px solid var(--border-light);
            color: var(--text-primary);
            padding: 14px 16px;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.3s;
            outline: none;
        }
        
        .input-classic:focus {
            border-color: var(--accent-primary);
            box-shadow: var(--glow-gold);
        }
        
        .input-label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }

        .btn-gold {
            background: linear-gradient(135deg, var(--accent-primary), #b89225);
            color: black;
            font-weight: 700;
            padding: 14px 24px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .btn-gold:hover {
            box-shadow: var(--glow-gold);
            transform: translateY(-2px);
        }
        .btn-gold:active { transform: translateY(0); }
        .btn-gold:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-light);
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-secondary:hover { border-color: var(--text-secondary); background: var(--bg-main); }

        /* --- Layout Structure --- */
        #app-container {
            display: grid;
            grid-template-columns: 420px 1fr; /* Fixed sidebar, fluid main content */
            height: 100vh;
        }

        #sidebar {
            background-color: var(--bg-secondary);
            border-left: 1px solid var(--border-light);
            padding: 24px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        #main-viewport {
            background-color: var(--bg-main);
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 24px;
            overflow-y: auto;
        }

        /* --- Specific Components --- */
        /* Style Selector Cards */
        .style-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }
        .style-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-light);
            padding: 16px;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }
        .style-card:hover { border-color: var(--accent-secondary); }
        .style-card.active {
            background: rgba(212, 175, 55, 0.1);
            border-color: var(--accent-primary);
        }
        .style-card i { font-size: 1.5rem; margin-bottom: 8px; color: var(--text-secondary); }
        .style-card.active i { color: var(--accent-primary); }

        /* The Canvas/Image Area */
        .viewport-stage {
            flex: 1;
            min-height: 500px;
            background-image: 
                linear-gradient(45deg, var(--bg-tertiary) 25%, transparent 25%), 
                linear-gradient(-45deg, var(--bg-tertiary) 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, var(--bg-tertiary) 75%), 
                linear-gradient(-45deg, transparent 75%, var(--bg-tertiary) 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            border-radius: 16px;
            border: 1px solid var(--border-light);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        #main-canvas {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
            box-shadow: var(--shadow-lg);
            transition: filter 0.3s ease;
        }

        /* Advanced Loader */
        .loader-overlay {
            position: absolute; inset: 0;
            background: rgba(10, 10, 15, 0.85);
            backdrop-filter: blur(10px);
            z-index: 50;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: 0.5s;
        }
        .loader-overlay.active { opacity: 1; pointer-events: all; }
        
        .gold-spinner {
            width: 60px; height: 60px;
            border: 4px solid var(--border-light);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Range Sliders for Editor */
        .slider-group { margin-bottom: 16px; }
        .slider-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.85rem; color: var(--text-secondary); }
        .classic-range {
            width: 100%; -webkit-appearance: none; height: 6px; border-radius: 5px; background: var(--bg-tertiary); outline: none;
        }
        .classic-range::-webkit-slider-thumb {
            -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; background: var(--accent-primary); cursor: pointer; transition: 0.2s;
        }
        .classic-range::-webkit-slider-thumb:hover { transform: scale(1.2); box-shadow: var(--glow-gold); }

        /* Responsive Design */
        @media (max-width: 1024px) {
            #app-container { grid-template-columns: 1fr; height: auto; overflow-y: auto; }
            #sidebar { height: auto; border-left: none; border-bottom: 1px solid var(--border-light); }
            #main-viewport { height: auto; min-height: 70vh; }
        }
    </style>
</head>
<body>

    <div id="app-container">
        
        <aside id="sidebar">
            <div class="flex items-center gap-3 pb-6 border-b border-border-light">
                <div class="w-10 h-10 bg-gradient-to-br from-accent-primary to-orange-600 rounded-lg flex items-center justify-center shadow-lg">
                    <i class="fa-solid fa-vector-square text-bg-main text-xl"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-accent-primary leading-none">NEXUS STUDIO</h1>
                    <span class="text-xs text-text-secondary tracking-widest">CLASSIC EDITION v2.0</span>
                </div>
            </div>

            <div class="space-y-6">
                <div>
                    <h2 class="text-sm text-accent-primary font-bold uppercase tracking-wider mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-layer-group"></i> أساسيات المشروع
                    </h2>
                    <div class="space-y-4">
                        <div>
                            <label for="brandName" class="input-label">اسم العلامة التجارية (Brand Name)</label>
                            <input type="text" id="brandName" placeholder="اكتب الاسم هنا..." class="input-classic text-lg font-bold" autocomplete="off">
                        </div>
                        <div>
                            <label for="tagline" class="input-label">الشعار اللفظي (اختياري)</label>
                            <input type="text" id="tagline" placeholder="مثال: Quality since 2020" class="input-classic">
                        </div>
                    </div>
                </div>

                <div>
                    <h2 class="text-sm text-accent-primary font-bold uppercase tracking-wider mb-4 flex items-center gap-2 mt-6">
                        <i class="fa-solid fa-compass-drafting"></i> التوجيه البصري
                    </h2>
                    <div class="space-y-4">
                        <div>
                            <label for="visualElement" class="input-label">العنصر الرمزي (Visual Symbol)</label>
                            <div class="relative">
                                <input type="text" id="visualElement" placeholder="مثال: رأس أسد هندسي، درع حماية..." class="input-classic pr-10">
                                <i class="fa-solid fa-lightbulb absolute right-4 top-1/2 -translate-y-1/2 text-text-muted"></i>
                            </div>
                            <div class="flex gap-2 mt-3 flex-wrap">
                                <button onclick="app.fillInput('visualElement', 'Geometric Falcon')" class="text-xs bg-bg-tertiary border border-border-light px-3 py-1.5 rounded-full hover:border-accent-primary transition">صقر هندسي</button>
                                <button onclick="app.fillInput('visualElement', 'Abstract Tech Circuit')" class="text-xs bg-bg-tertiary border border-border-light px-3 py-1.5 rounded-full hover:border-accent-primary transition">دائرة تقنية</button>
                                <button onclick="app.fillInput('visualElement', 'Minimalist Mountain')" class="text-xs bg-bg-tertiary border border-border-light px-3 py-1.5 rounded-full hover:border-accent-primary transition">جبل بسيط</button>
                            </div>
                        </div>

                        <div>
                            <label class="input-label mb-3">الأسلوب الفني (Artistic Style)</label>
                            <div class="style-grid">
                                <div class="style-card active" onclick="app.selectStyle(this, 'classic_luxury')">
                                    <i class="fa-solid fa-crown"></i>
                                    <div class="text-sm font-bold">Classic Luxury</div>
                                </div>
                                <div class="style-card" onclick="app.selectStyle(this, 'modern_minimal')">
                                    <i class="fa-solid fa-bezier-curve"></i>
                                    <div class="text-sm font-bold">Modern Minimal</div>
                                </div>
                                <div class="style-card" onclick="app.selectStyle(this, 'vintage_badge')">
                                    <i class="fa-solid fa-certificate"></i>
                                    <div class="text-sm font-bold">Vintage Badge</div>
                                </div>
                                <div class="style-card" onclick="app.selectStyle(this, 'abstract_mark')">
                                    <i class="fa-brands fa-codepen"></i>
                                    <div class="text-sm font-bold">Abstract Mark</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="pt-4">
                            <label class="flex items-center gap-3 cursor-pointer group">
                                <input type="checkbox" id="transparentBg" class="w-5 h-5 accent-accent-primary cursor-pointer">
                                <span class="text-sm text-text-secondary group-hover:text-text-primary transition">طلب خلفية شفافة (PNG)</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-auto pt-6 border-t border-border-light sticky bottom-0 bg-bg-secondary">
                <button id="generateBtn" onclick="core.initiateGeneration()" class="btn-gold w-full text-lg">
                    <i class="fa-solid fa-wand-magic-sparkles"></i>
                    <span>بدء تصميم الشعار</span>
                </button>
                <p id="statusText" class="text-center text-xs text-text-muted mt-3 font-mono h-4"></p>
            </div>
        </aside>

        <main id="main-viewport">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    <i class="fa-solid fa-image"></i> مساحة العمل
                </h2>
                <button onclick="gallery.toggle()" class="btn-secondary text-sm">
                    <i class="fa-solid fa-clock-rotate-left"></i> السجل
                </button>
            </div>

            <div class="viewport-stage panel-classic relative group">
                <div id="stagePlaceholder" class="text-center text-text-muted flex flex-col items-center transition-all duration-300">
                    <i class="fa-solid fa-compass-drafting text-6xl mb-4 opacity-50"></i>
                    <h3 class="text-xl font-bold text-text-primary mb-2">اللوحة جاهزة</h3>
                    <p class="max-w-md">أدخل تفاصيل مشروعك في القائمة الجانبية لبدء عملية التصميم.</p>
                </div>

                <canvas id="main-canvas" class="hidden"></canvas>

                <div id="loaderOverlay" class="loader-overlay">
                    <div class="gold-spinner mb-6"></div>
                    <h3 class="text-xl font-bold text-accent-primary mb-2 tracking-wider">جاري المعالجة</h3>
                    <p id="loaderStatus" class="text-text-secondary font-mono text-sm">Initializing AI Core...</p>
                    <div class="w-64 h-1.5 bg-bg-tertiary rounded-full mt-6 overflow-hidden">
                        <div id="progressBar" class="h-full bg-accent-primary w-0 transition-all duration-[10s] ease-out"></div>
                    </div>
                </div>
            </div>

            <div id="editorPanel" class="panel-classic p-6 hidden animate-pulse">
                <div class="flex justify-between items-center mb-6 pb-4 border-b border-border-light">
                     <h3 class="font-bold text-lg flex items-center gap-2">
                        <i class="fa-solid fa-sliders"></i> محرر اللمسات الأخيرة
                    </h3>
                    <div class="flex gap-2">
                        <button onclick="editor.reset()" class="btn-secondary text-xs px-3 py-1.5">إعادة تعيين</button>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="space-y-4">
                        <h4 class="text-xs font-bold text-text-secondary uppercase">الإضاءة والتباين</h4>
                        <div class="slider-group">
                            <div class="slider-header"><span>السطوع (Brightness)</span><span id="val-brightness">100%</span></div>
                            <input type="range" id="in-brightness" min="50" max="150" value="100" class="classic-range" oninput="editor.update('brightness', this.value)">
                        </div>
                        <div class="slider-group">
                            <div class="slider-header"><span>التباين (Contrast)</span><span id="val-contrast">100%</span></div>
                            <input type="range" id="in-contrast" min="50" max="150" value="100" class="classic-range" oninput="editor.update('contrast', this.value)">
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <h4 class="text-xs font-bold text-text-secondary uppercase">الألوان والتشبع</h4>
                        <div class="slider-group">
                            <div class="slider-header"><span>التشبع (Saturation)</span><span id="val-saturate">100%</span></div>
                            <input type="range" id="in-saturate" min="0" max="200" value="100" class="classic-range" oninput="editor.update('saturate', this.value)">
                        </div>
                        <div class="slider-group">
                            <div class="slider-header"><span>تدريج اللون (Hue)</span><span id="val-hue-rotate">0deg</span></div>
                            <input type="range" id="in-hue-rotate" min="0" max="360" value="0" class="classic-range" oninput="editor.update('hue-rotate', this.value, 'deg')">
                        </div>
                    </div>

                     <div class="flex flex-col justify-between gap-4">
                        <div>
                            <h4 class="text-xs font-bold text-text-secondary uppercase mb-3">لوحة الألوان المستخرجة</h4>
                            <div id="colorPalette" class="flex gap-2 p-2 bg-bg-tertiary rounded-lg">
                                <span class="text-xs text-text-muted">سيتم استخراج الألوان بعد الإنشاء</span>
                            </div>
                        </div>
                        <button id="downloadBtn" onclick="editor.download()" class="btn-gold w-full py-4 mt-auto">
                            <i class="fa-solid fa-download"></i> تحميل الشعار النهائي (HD)
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <div id="gallerySidebar" class="fixed top-0 right-0 h-full w-80 bg-bg-secondary border-l border-border-light z-50 transform translate-x-full transition-transform duration-300 p-6 overflow-y-auto shadow-2xl">
             <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-lg"><i class="fa-solid fa-clock-rotate-left mr-2"></i>سجل التصاميم</h3>
                <button onclick="gallery.toggle()" class="text-text-secondary hover:text-text-primary"><i class="fa-solid fa-times text-xl"></i></button>
            </div>
            <div id="galleryGrid" class="grid grid-cols-1 gap-4">
                </div>
             <button onclick="gallery.clear()" class="btn-secondary w-full mt-6 text-accent-danger border-accent-danger/30 hover:bg-accent-danger/10">
                <i class="fa-solid fa-trash"></i> مسح السجل
            </button>
        </div>
    </div>

    <script>
        /**
         * GLOBAL CONFIGURATION & STATE
         * Defines base API endpoints, style prompts, and active application state.
         */
        const CONFIG = {
            // Using the most reliable endpoint path based on recent tests
            apiBase: "https://image.pollinations.ai/prompt/",
            
            // Pre-defined professional prompt modifiers
            styles: {
                classic_luxury: "luxury logo design, classic emblem, elegant serif typography, gold and deep rich colors, metallic texture, premium branding, centered, highly detailed, 8k resolution",
                modern_minimal: "minimalist logo, modern flat design, clean geometric lines, sans-serif font, abstract icon, balanced, negative space, isolated on plain background",
                vintage_badge: "vintage retro badge logo, textured stamp effect, old school typography, circular emblem, rustic colors, intricate details, grunge texture",
                abstract_mark: "abstract logo mark, futuristic shapes, gradient colors, fluid design, tech company branding, innovative symbol, clean render"
            },

            // Status messages for the loader
            statusMessages: [
                "جاري تهيئة محرك الذكاء الاصطناعي...",
                "تحليل مدخلات العلامة التجارية...",
                "رسم الخطوط الأولية...",
                "تطبيق أسلوب التصميم المختار...",
                "إضافة اللمسات النهائية والظلال...",
                "جاري تحسين الدقة (Upscaling)..."
            ]
        };

        // Main State Object
        let state = {
            isGenerating: false,
            currentStyle: 'classic_luxury',
            currentImageUrl: null,
            // Editor filter values
            filters: {
                brightness: 100,
                contrast: 100,
                saturate: 100,
                'hue-rotate': 0,
                sepia: 0
            },
            // History array loaded from local storage
            history: JSON.parse(localStorage.getItem('nexus_history')) || []
        };

        /**
         * MODULE: UI CONTROLLER (app)
         * Handles general interface interactions.
         */
        const app = {
            init() {
                // Initial setup on page load
                gallery.render();
                console.log("Nexus Studio: Classic Edition Initialized.");
            },

            // Helper to fill example inputs
            fillInput(id, value) {
                document.getElementById(id).value = value;
            },

            // Handle style card selection
            selectStyle(element, styleKey) {
                if (state.isGenerating) return;
                // Update UI
                document.querySelectorAll('.style-card').forEach(el => el.classList.remove('active'));
                element.classList.add('active');
                // Update State
                state.currentStyle = styleKey;
            },

            // Update status text near the button
            setStatus(msg, type = 'normal') {
                const el = document.getElementById('statusText');
                el.innerText = msg;
                el.className = type === 'error' ? 'text-center text-xs text-accent-danger mt-3 font-mono h-4' : 'text-center text-xs text-text-muted mt-3 font-mono h-4';
            }
        };

        /**
         * MODULE: CORE ENGINE (core)
         * Handles the generation process, API calls, and loading states.
         */
        const core = {
            async initiateGeneration() {
                if (state.isGenerating) return;

                // 1. Validation
                const brandName = document.getElementById('brandName').value.trim();
                if (!brandName) {
                    alert("يرجى إدخال اسم العلامة التجارية أولاً.");
                    document.getElementById('brandName').focus();
                    return;
                }

                // 2. Prepare State & UI
                state.isGenerating = true;
                const generateBtn = document.getElementById('generateBtn');
                generateBtn.disabled = true;
                generateBtn.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin"></i><span>جاري العمل...</span>';
                
                document.getElementById('stagePlaceholder').classList.add('hidden');
                document.getElementById('editorPanel').classList.add('hidden');
                this.toggleLoader(true);

                // 3. Construct the Advanced Prompt
                const visualElement = document.getElementById('visualElement').value.trim();
                const tagline = document.getElementById('tagline').value.trim();
                const isTransparent = document.getElementById('transparentBg').checked;
                
                const baseStyle = CONFIG.styles[state.currentStyle];
                
                let fullPrompt = `${baseStyle}. A professional logo for brand "${brandName}".`;
                if (visualElement) fullPrompt += ` Featuring an icon of: ${visualElement}.`;
                if (tagline) fullPrompt += ` Incorporating the tagline: "${tagline}".`;
                if (isTransparent) fullPrompt += ` Isolated on a transparent background, no background elements.`;
                else fullPrompt += ` Centered on a clean professional background.`;

                console.log("Generating with prompt:", fullPrompt);

                // 4. API Call with "Smart Routing" (Retries)
                // We use a random seed to prevent caching and force a new generation.
                const seed = Math.floor(Math.random() * 99999999);
                constencodedPrompt = encodeURIComponent(fullPrompt);
                
                // Primary URL structure (most reliable currently)
                const targetUrl = `${CONFIG.apiBase}${encodedPrompt}?width=1024&height=1024&seed=${seed}&nologo=true&model=turbo`; // Adding model=turbo for speed

                try {
                    await this.loadImageWithFallback(targetUrl);
                    // Success handled in loadImageWithFallback callback
                } catch (error) {
                    console.error("Generation Failed:", error);
                    app.setStatus("فشل الاتصال بالسيرفر. يرجى المحاولة مرة أخرى.", "error");
                    this.resetUIState();
                }
            },

            // Smart Image Loader with timeout and error handling
            loadImageWithFallback(url) {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.crossOrigin = "Anonymous"; // Crucial for Canvas editing later

                    // Timeout warning
                    const timeoutToast = setTimeout(() => {
                         app.setStatus("الاتصال يستغرق وقتاً أطول من المعتاد...");
                    }, 8000);

                    img.onload = () => {
                        clearTimeout(timeoutToast);
                        this.handleGenerationSuccess(img, url);
                        resolve(url);
                    };

                    img.onerror = () => {
                        clearTimeout(timeoutToast);
                        // Simple retry logic could be added here, but for now fail fast.
                        reject(new Error("Image failed to load"));
                    };

                    img.src = url;
                });
            },

            handleGenerationSuccess(imgObj, url) {
                // Update State
                state.currentImageUrl = url;
                
                // Initialize Editor with the new image
                editor.init(imgObj);
                
                // Save to History
                gallery.add(url, document.getElementById('brandName').value);

                // Update UI
                this.resetUIState();
                document.getElementById('editorPanel').classList.remove('hidden');
                app.setStatus("تم إنشاء الشعار بنجاح!");
                // Extract colors (simple simulation for now)
                this.extractColors();
            },

            toggleLoader(show) {
                 const loader = document.getElementById('loaderOverlay');
                 const progressBar = document.getElementById('progressBar');
                 const statusText = document.getElementById('loaderStatus');

                 if (show) {
                     loader.classList.add('active');
                     progressBar.style.width = '100%'; // Start animation
                     
                     // Cycle status messages
                     let msgIndex = 0;
                     statusText.innerText = CONFIG.statusMessages[0];
                     this.msgInterval = setInterval(() => {
                         msgIndex = (msgIndex + 1) % CONFIG.statusMessages.length;
                         statusText.innerText = CONFIG.statusMessages[msgIndex];
                     }, 2000);

                 } else {
                     loader.classList.remove('active');
                     progressBar.style.width = '0';
                     clearInterval(this.msgInterval);
                 }
            },

            resetUIState() {
                state.isGenerating = false;
                this.toggleLoader(false);
                const generateBtn = document.getElementById('generateBtn');
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles"></i><span>بدء تصميم الشعار</span>';
            },

            // Simulates color extraction (a real one needs complex JS libraries)
            extractColors() {
                const paletteContainer = document.getElementById('colorPalette');
                paletteContainer.innerHTML = '';
                
                // Generate 4 pseudo-random complementary colors based on the style
                const baseColors = state.currentStyle === 'classic_luxury' ? ['#d4af37', '#0a0a0f', '#ffffff', '#888888'] : 
                                   state.currentStyle === 'modern_minimal' ? ['#3b82f6', '#ffffff', '#000000', '#e5e7eb'] :
                                   ['#FF5733', '#C70039', '#900C3F', '#581845']; // Fallback

                baseColors.forEach(color => {
                    const colorDot = document.createElement('div');
                    colorDot.className = 'w-8 h-8 rounded-full border border-border-light shadow-sm cursor-pointer hover:scale-110 transition';
                    colorDot.style.backgroundColor = color;
                    colorDot.title = color;
                    colorDot.onclick = () => { navigator.clipboard.writeText(color); alert(`تم نسخ كود اللون: ${color}`); };
                    paletteContainer.appendChild(colorDot);
                });
            }
        };

        /**
         * MODULE: IMAGE EDITOR (editor)
         * Handles canvas manipulation for post-processing features.
         */
        const editor = {
            canvas: null,
            ctx: null,
            originalImage: null,

            init(imgObj) {
                this.canvas = document.getElementById('main-canvas');
                this.ctx = this.canvas.getContext('2d');
                this.originalImage = imgObj;

                // Set canvas dimensions to match image
                this.canvas.width = imgObj.width;
                this.canvas.height = imgObj.height;
                
                // Show canvas
                this.canvas.classList.remove('hidden');

                // Initial Draw
                this.reset();
            },

            // Called when a slider changes
            update(filterType, value, unit = '%') {
                // Update UI label
                document.getElementById(`val-${filterType}`).innerText = value + unit;
                // Update State
                state.filters[filterType] = value;
                // Redraw
                this.applyFilters();
            },

            applyFilters() {
                if (!this.ctx || !this.originalImage) return;

                // Clear previous frame
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);

                // Construct CSS filter string based on state
                const f = state.filters;
                this.ctx.filter = `
                    brightness(${f.brightness}%) 
                    contrast(${f.contrast}%) 
                    saturate(${f.saturate}%) 
                    hue-rotate(${f['hue-rotate']}deg)
                `;

                // Draw the image with filters applied
                this.ctx.drawImage(this.originalImage, 0, 0);
            },

            reset() {
                // Reset state variables
                state.filters = { brightness: 100, contrast: 100, saturate: 100, 'hue-rotate': 0, sepia: 0 };
                
                // Reset sliders UI
                document.getElementById('in-brightness').value = 100; document.getElementById('val-brightness').innerText = '100%';
                document.getElementById('in-contrast').value = 100; document.getElementById('val-contrast').innerText = '100%';
                document.getElementById('in-saturate').value = 100; document.getElementById('val-saturate').innerText = '100%';
                document.getElementById('in-hue-rotate').value = 0; document.getElementById('val-hue-rotate').innerText = '0deg';

                this.applyFilters();
            },

            download() {
                if (!this.canvas) return;
                
                // Use the canvas data (with filters applied)
                const dataURL = this.canvas.toDataURL('image/png');
                
                const link = document.createElement('a');
                link.download = `Nexus_Logo_${Date.now()}.png`;
                link.href = dataURL;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        };

        /**
         * MODULE: GALLERY / HISTORY (gallery)
         * Manages local storage persistence of generated images.
         */
        const gallery = {
            sidebar: document.getElementById('gallerySidebar'),
            grid: document.getElementById('galleryGrid'),

            toggle() {
                this.sidebar.classList.toggle('translate-x-full');
            },

            add(url, name) {
                // Add to state array (limit to last 10)
                state.history.unshift({ url, name, date: new Date().toLocaleDateString() });
                if (state.history.length > 10) state.history.pop();
                
                // Save to LocalStorage
                localStorage.setItem('nexus_history', JSON.stringify(state.history));
                
                this.render();
            },

            render() {
                this.grid.innerHTML = '';
                if (state.history.length === 0) {
                    this.grid.innerHTML = '<p class="text-text-muted text-center py-4">لا يوجد سجل حتى الآن</p>';
                    return;
                }

                state.history.forEach((item, index) => {
                    const card = document.createElement('div');
                    card.className = 'bg-bg-tertiary border border-border-light rounded-lg overflow-hidden flex gap-3 p-2 items-center hover:border-accent-secondary transition cursor-pointer';
                    card.innerHTML = `
                        <img src="${item.url}" class="w-16 h-16 object-cover rounded border border-border-light bg-bg-main">
                        <div class="flex-1 overflow-hidden">
                            <h4 class="font-bold truncate">${item.name}</h4>
                            <span class="text-xs text-text-muted">${item.date}</span>
                        </div>
                        <button onclick="gallery.restore(${index})" class="btn-secondary text-xs px-2 py-1"><i class="fa-solid fa-upload"></i></button>
                    `;
                    this.grid.appendChild(card);
                });
            },

            restore(index) {
                const item = state.history[index];
                // Load image back into editor
                core.toggleLoader(true);
                const img = new Image();
                img.crossOrigin = "Anonymous";
                img.onload = () => {
                    editor.init(img);
                    document.getElementById('editorPanel').classList.remove('hidden');
                    document.getElementById('stagePlaceholder').classList.add('hidden');
                    core.toggleLoader(false);
                    this.toggle(); // Close sidebar
                };
                img.src = item.url;
            },

            clear() {
                if(confirm('هل أنت متأكد من مسح السجل بالكامل؟')) {
                    state.history = [];
                    localStorage.removeItem('nexus_history');
                    this.render();
                }
            }
        };

        // --- Initialize Application ---
        // Wait for DOM to be ready
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });

    </script>
</body>
</html>
